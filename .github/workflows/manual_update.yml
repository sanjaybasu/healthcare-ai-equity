name: Manual Literature Update

on:
  workflow_dispatch:
    inputs:
      date_range:
        description: 'Number of days to search back'
        required: true
        default: '7'
        type: choice
        options:
          - '1'
          - '7'
          - '14'
          - '30'
      dry_run:
        description: 'Dry run (no PR created)'
        required: true
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  manual-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify chapters directory
        run: |
          echo "Checking for chapters..."
          ls -la _chapters/
          echo "Chapter count: $(ls -1 _chapters/*.md | wc -l)"
      
      - name: Run manual update
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PUBMED_API_KEY: ${{ secrets.PUBMED_API_KEY }}
        run: |
          python scripts/search_literature.py --date-range ${{ inputs.date_range }}
          python scripts/assess_relevance.py --chapters-dir _chapters
          python scripts/update_chapters.py --chapters-dir _chapters --dry-run ${{ inputs.dry_run }}
      
      - name: Display results
        run: |
          echo "## Manual Update Results" >> $GITHUB_STEP_SUMMARY
          echo "- Date range: ${{ inputs.date_range }} days" >> $GITHUB_STEP_SUMMARY
          echo "- Dry run: ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          if [ -f data/update_summary.json ]; then
            cat data/update_summary.json >> $GITHUB_STEP_SUMMARY
          fi
